name: CI/CD con Docker Compose

on:
  push:
    branches:
      - main2
  pull_request:
    branches:
      - main

jobs:
  # Job 1: Construir y levantar servicios
  construir_y_levantar:
    runs-on: ubuntu-latest
    services:
      base_de_datos:
        image: postgres:latest
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: shopdb
        ports:
          - 5432:5432
      cola_de_mensajes:
        image: rabbitmq:management
        ports:
          - 5672:5672
          - 15672:15672
    steps:
      - name: Descargar código
        uses: actions/checkout@v3

      - name: Verificar Docker y Docker Compose
        run: |
          docker --version
          docker compose version

      - name: Construir y levantar contenedores
        run: docker compose up -d --build

      - name: Esperar a que los servicios se inicien
        run: sleep 10

      - name: Verificar contenedores en ejecución
        run: docker ps

  # Job 2: Pruebas unitarias
  pruebas_unitarias:
    runs-on: ubuntu-latest
    needs: construir_y_levantar # Este job depende de que "construir_y_levantar" termine
    steps:
      - name: Descargar código
        uses: actions/checkout@v3

      - name: Ejecutar pruebas unitarias de Rails
        run: docker compose exec -T rails_app bash -c "bundle exec rspec spec/models"

      - name: Ejecutar pruebas unitarias de Flask
        run: docker compose exec -T python_app pytest tests/unit

  # Job 3: Pruebas de integración
  pruebas_integracion:
    runs-on: ubuntu-latest
    needs: construir_y_levantar # Este job depende de que "construir_y_levantar" termine
    steps:
      - name: Descargar código
        uses: actions/checkout@v3

      - name: Ejecutar pruebas de integración de Rails
        run: docker compose exec -T rails_app bash -c "bundle exec rspec spec/integration"

      - name: Ejecutar pruebas de integración de Flask
        run: docker compose exec -T python_app pytest tests/integration

  # Job 4: Análisis de código estático (DESACTIVADO)
  # analisis_codigo:
  #   runs-on: ubuntu-latest
  #   needs: construir_y_levantar # Este job depende de que "construir_y_levantar" termine
  #   steps:
  #     - name: Descargar código
  #       uses: actions/checkout@v3

  #     - name: Ejecutar RuboCop para Rails
  #       run: docker compose exec -T rails_app bash -c "bundle exec rubocop"

  #     - name: Ejecutar Flake8 para Flask
  #       run: docker compose exec -T python_app flake8 app.py

  # Job 5: Despliegue (opcional)
  despliegue:
    runs-on: ubuntu-latest
    needs: [pruebas_unitarias, pruebas_integracion] # Este job depende de que los anteriores terminen
    steps:
      - name: Descargar código
        uses: actions/checkout@v3

      - name: Desplegar aplicación
        run: echo "Desplegando la aplicación..."
